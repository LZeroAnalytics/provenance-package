#!/bin/sh

# Simplified startup script with minimal resource usage
mkdir -p {{ .config_folder }}
mkdir -p /var/tmp

# Create node ID file early with a default value
echo "{\"node_id\": \"66b0a86de451b0f92e6159e13d695400e326e08b\"}" > {{ .node_id_file }}
chmod 777 {{ .node_id_file }}

# Initialize node if not already initialized
if [ ! -f {{ .config_folder }}/genesis.json ]; then
    # Initialize the node
    {{ .binary }} init node-0 --chain-id provenance-testnet-1
    
    # Import key from mnemonic
    echo "{{ .mnemonic }}" | {{ .binary }} keys add node-0 {{ .keyring_flags }} --recover
    
    # Import faucet key if provided
    if [ -n "{{ .faucet_mnemonic }}" ]; then
        echo "{{ .faucet_mnemonic }}" | {{ .binary }} keys add faucet {{ .keyring_flags }} --recover
    fi
    
    # Copy genesis file
    cp {{ .genesis_file_path }} {{ .config_folder }}/genesis.json
    
    # Configure node
    sed -i 's/cors_allowed_origins = \[\]/cors_allowed_origins = \["*"\]/g' {{ .config_folder }}/config.toml
    sed -i 's/prometheus = false/prometheus = true/g' {{ .config_folder }}/config.toml
    sed -i 's/prometheus_listen_addr = ":26660"/prometheus_listen_addr = "{{ .prometheus_listen_addr }}"/g' {{ .config_folder }}/config.toml
    
    # Enable API and set CORS
    sed -i 's/enable = false/enable = true/g' {{ .config_folder }}/app.toml
    sed -i 's/enabled-unsafe-cors = false/enabled-unsafe-cors = true/g' {{ .config_folder }}/app.toml
    
    # Set minimum gas prices
    sed -i 's/minimum-gas-prices = ""/minimum-gas-prices = "0.025nhash"/g' {{ .config_folder }}/app.toml
    
    # Update the node ID file with the actual node ID
    NODE_ID=$({{ .binary }} tendermint show-node-id 2>/dev/null)
    if [ -n "$NODE_ID" ]; then
        echo "{\"node_id\": \"$NODE_ID\"}" > {{ .node_id_file }}
        chmod 777 {{ .node_id_file }}
    fi
fi

# Start the node in foreground to keep container running
exec {{ .binary }} start {{ .rpc_options }} {{ .seed_options }} {{ .start_args }}
