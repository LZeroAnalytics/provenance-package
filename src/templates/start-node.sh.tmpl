#!/bin/sh

# Remove -e to prevent script from exiting on error for debugging
set -x

# Create directories if they don't exist
mkdir -p {{ .config_folder }}
mkdir -p /var/tmp

# Debug information
echo "DEBUG: Current directory: $(pwd)"
echo "DEBUG: Listing config folder: $(ls -la {{ .config_folder }} 2>/dev/null || echo 'Config folder not found')"
echo "DEBUG: Checking binary: $(which {{ .binary }} || echo 'Binary not found')"

# Initialize node if not already initialized
if [ ! -f {{ .config_folder }}/genesis.json ]; then
    echo "Initializing node..."
    {{ .binary }} init node-0 --chain-id provenance-testnet-1 || echo "Init failed with code $?"
    
    # Import key from mnemonic
    echo "Importing key from mnemonic..."
    echo "{{ .mnemonic }}" | {{ .binary }} keys add node-0 {{ .keyring_flags }} --recover || echo "Key import failed with code $?"
    
    # Import faucet key if provided
    if [ -n "{{ .faucet_mnemonic }}" ]; then
        echo "Importing faucet key..."
        echo "{{ .faucet_mnemonic }}" | {{ .binary }} keys add faucet {{ .keyring_flags }} --recover || echo "Faucet key import failed with code $?"
    fi
    
    # Copy genesis file
    echo "Copying genesis file..."
    cp {{ .genesis_file_path }} {{ .config_folder }}/genesis.json || echo "Genesis copy failed with code $?"
    
    # Fix marker module parameters in genesis file to prevent uint64 overflow
    echo "Fixing marker module parameters..."
    # Use jq for more reliable JSON manipulation
    if command -v jq >/dev/null 2>&1; then
        echo "Using jq to fix marker parameters..."
        jq '.app_state.marker.params.max_supply = "18446744073709551615" | .app_state.marker.params.max_total_supply = "18446744073709551615"' {{ .config_folder }}/genesis.json > {{ .config_folder }}/genesis.json.fixed
        if [ -s {{ .config_folder }}/genesis.json.fixed ]; then
            mv {{ .config_folder }}/genesis.json.fixed {{ .config_folder }}/genesis.json
        else
            echo "ERROR: jq produced empty output, falling back to sed"
            sed -i 's/"max_supply": "[0-9]*"/"max_supply": "18446744073709551615"/g' {{ .config_folder }}/genesis.json || echo "max_supply fix failed with code $?"
            sed -i 's/"max_total_supply": "[0-9]*"/"max_total_supply": "18446744073709551615"/g' {{ .config_folder }}/genesis.json || echo "max_total_supply fix failed with code $?"
        fi
    else
        echo "jq not found, using sed for marker parameter fixes..."
        sed -i 's/"max_supply": "[0-9]*"/"max_supply": "18446744073709551615"/g' {{ .config_folder }}/genesis.json || echo "max_supply fix failed with code $?"
        sed -i 's/"max_total_supply": "[0-9]*"/"max_total_supply": "18446744073709551615"/g' {{ .config_folder }}/genesis.json || echo "max_total_supply fix failed with code $?"
    fi
    
    # Verify the fix was applied
    echo "Verifying marker module parameter fixes:"
    if command -v jq >/dev/null 2>&1; then
        jq '.app_state.marker.params' {{ .config_folder }}/genesis.json
    else
        grep -A 5 max_supply {{ .config_folder }}/genesis.json || echo "max_supply not found"
        grep -A 5 max_total_supply {{ .config_folder }}/genesis.json || echo "max_total_supply not found"
    fi
    
    # Configure node
    echo "Configuring node..."
    sed -i 's/cors_allowed_origins = \[\]/cors_allowed_origins = \["*"\]/g' {{ .config_folder }}/config.toml || echo "CORS config failed with code $?"
    sed -i 's/prometheus = false/prometheus = true/g' {{ .config_folder }}/config.toml || echo "Prometheus config failed with code $?"
    sed -i 's/prometheus_listen_addr = ":26660"/prometheus_listen_addr = "{{ .prometheus_listen_addr }}"/g' {{ .config_folder }}/config.toml || echo "Prometheus addr config failed with code $?"
    
    # Enable API and set CORS
    sed -i 's/enable = false/enable = true/g' {{ .config_folder }}/app.toml || echo "API enable failed with code $?"
    sed -i 's/enabled-unsafe-cors = false/enabled-unsafe-cors = true/g' {{ .config_folder }}/app.toml || echo "CORS config failed with code $?"
    
    # Set minimum gas prices
    sed -i 's/minimum-gas-prices = ""/minimum-gas-prices = "0.025nhash"/g' {{ .config_folder }}/app.toml || echo "Gas price config failed with code $?"
    
    # Get node ID and save it to a file
    echo "Getting node ID..."
    NODE_ID=$({{ .binary }} tendermint show-node-id) || echo "Node ID retrieval failed with code $?"
    echo "Node ID: $NODE_ID"
    mkdir -p $(dirname {{ .node_id_file }})
    echo "{\"node_id\": \"$NODE_ID\"}" > {{ .node_id_file }} || echo "Node ID file creation failed with code $?"
    chmod 777 {{ .node_id_file }} || echo "Changing permissions failed with code $?"
    echo "Node ID file created at {{ .node_id_file }}"
    ls -la {{ .node_id_file }} || echo "Cannot list node ID file"
fi

# Debug information before starting
echo "DEBUG: Listing config folder after setup: $(ls -la {{ .config_folder }})"
echo "DEBUG: Checking node ID file: $(cat {{ .node_id_file }} 2>/dev/null || echo 'Node ID file not found')"
echo "DEBUG: Checking genesis file content:"
cat {{ .config_folder }}/genesis.json | grep -A 5 marker || echo "marker section not found in genesis"

# Start the node with nohup to keep it running even if the script exits
echo "Starting node..."
# Run in background and redirect output to log file
nohup {{ .binary }} start {{ .rpc_options }} {{ .seed_options }} {{ .start_args }} > /var/log/provenance.log 2>&1 &

# Store the PID
PID=$!
echo "Node started with PID: $PID"

# Wait for the node to start or fail
sleep 5
if ps -p $PID > /dev/null; then
    echo "Node is running with PID: $PID"
    # Wait for RPC to be available
    for i in $(seq 1 60); do
        if curl -s http://localhost:26657/status > /dev/null; then
            echo "RPC is available"
            break
        fi
        echo "Waiting for RPC to be available... ($i/60)"
        sleep 2
    done
else
    echo "Node failed to start. Check logs:"
    tail -n 50 /var/log/provenance.log
    exit 1
fi

# Keep the container running
tail -f /var/log/provenance.log
